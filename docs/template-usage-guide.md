# MetX Template Usage Guide

## Overview
This approach breaks down MetX JSON generation into three components:
1. **Static Prefix** (`metx-prefix-template.txt`)
2. **Dynamic Layers** (generated by LLM using `metx-layers-only-prompt.md`)
3. **Static Suffix** (`metx-suffix-template.txt`)

## Template Assembly Process

### Step 1: Prepare the Prefix
Use `metx-prefix-template.txt` and replace these placeholders:

| Placeholder | Description | Example Value |
|-------------|-------------|---------------|
| `{{DASHBOARD_TITLE}}` | Dashboard name | "Weather Overview" |
| `{{TAB_TITLE}}` | Tab name | "Current Conditions" |
| `{{MAP_TITLE}}` | Map title | "Temperature and Wind" |
| `{{MAP_TITLE_STYLE}}` | Title styling | `null` or `{"color":"#000000","fontSize":16}` |
| `{{MAP_PROJECTION}}` | Map projection | `null` or `{"name":"mercator"}` |
| `{{CENTER_LNG}}` | Map center longitude | `8.5` |
| `{{CENTER_LAT}}` | Map center latitude | `47.0` |
| `{{ZOOM_LEVEL}}` | Map zoom level | `6.0` |
| `{{SW_LNG}}` | Southwest longitude | `5.0` |
| `{{SW_LAT}}` | Southwest latitude | `45.0` |
| `{{NE_LNG}}` | Northeast longitude | `12.0` |
| `{{NE_LAT}}` | Northeast latitude | `49.0` |

### Step 2: Generate Layers
Use the `metx-layers-only-prompt.md` prompt with an LLM to generate **only** the layers array content.

**Example input to LLM:**
```
Weather Request: Show temperature map with wind barbs for Switzerland
Geographic Context: Switzerland region, zoom level appropriate for country view
```

**Expected LLM output:**
```json
{
  "time_created": "2025-01-01T12:00:00Z",
  "time_updated": "2025-01-01T12:00:00Z",
  "id": 600001,
  "id_profile": 12000,
  "id_cartographicmap": 120000,
  "index": 0,
  "opacity": 1,
  "show": true,
  "calibrated": null,
  "vertical_interpolation": null,
  "experimental": false,
  "custom_options": {
    "line_color": null,
    "show_state_border": null,
    "map_label_language": null
  },
  "kind": "BackgroundMapDescription",
  "style": "basic"
},
{
  "time_created": "2025-01-01T12:00:00Z",
  "time_updated": "2025-01-01T12:00:00Z",
  "id": 600002,
  "id_profile": 12000,
  "id_cartographicmap": 120000,
  "index": 1,
  "opacity": 0.7,
  "show": true,
  "calibrated": false,
  "vertical_interpolation": null,
  "experimental": false,
  "custom_options": {
    "init_date": null
  },
  "model": "mix",
  "parameter_unit": "t_2m:C",
  "ens_select": null,
  "show_init_time": false,
  "kind": "WmsLayerDescription",
  "color_map": "",
  "legend_visible": true
},
{
  "id": 600003,
  "id_profile": 12000,
  "id_cartographicmap": 120000,
  "time_created": "2025-01-01T12:00:00Z",
  "time_updated": "2025-01-01T12:00:00Z",
  "index": 2,
  "opacity": 0.7,
  "show": true,
  "calibrated": false,
  "vertical_interpolation": null,
  "experimental": false,
  "custom_options": {
    "icon_size": 0.5
  },
  "model": "mix",
  "parameter_unit": "wind_speed_10m:kn",
  "ens_select": null,
  "show_init_time": false,
  "step": 35,
  "kind": "BarbsLayerDescription",
  "parameter_unit_paired": "wind_dir_10m:d",
  "element_color": "#000000"
}
```

### Step 3: Combine All Parts
Concatenate: `prefix + layers + suffix`

**Final JSON Structure:**
```
[PREFIX_CONTENT]
[LLM_GENERATED_LAYERS]
[SUFFIX_CONTENT]
```

## Implementation Example (Python)

```python
def generate_metx_dashboard(user_request, geographic_context=None):
    # Step 1: Load templates
    with open('metx-prefix-template.txt', 'r') as f:
        prefix_template = f.read()
    
    with open('metx-suffix-template.txt', 'r') as f:
        suffix_template = f.read()
    
    with open('metx-layers-only-prompt.md', 'r') as f:
        layers_prompt = f.read()
    
    # Step 2: Fill prefix placeholders
    prefix = prefix_template.replace('{{DASHBOARD_TITLE}}', extract_title(user_request))
    prefix = prefix.replace('{{TAB_TITLE}}', extract_tab_title(user_request))
    prefix = prefix.replace('{{MAP_TITLE}}', extract_map_title(user_request))
    # ... replace other placeholders
    
    # Step 3: Generate layers using LLM
    llm_input = f"{layers_prompt}\n\nWeather Request: {user_request}"
    if geographic_context:
        llm_input += f"\nGeographic Context: {geographic_context}"
    
    layers_content = call_llm(llm_input)
    
    # Step 4: Combine
    final_json = prefix + layers_content + suffix_template
    
    return final_json
```

## Benefits of This Approach

1. **Focused LLM Task**: The LLM only needs to generate the complex, variable part (layers)
2. **Consistent Structure**: The wrapper JSON is always valid and consistent
3. **Cost Efficient**: Smaller prompts and responses
4. **Easy Debugging**: Can validate each part separately
5. **Template Evolution**: Can update templates without changing the LLM prompt

## Validation
After combining, validate that:
- The final JSON is valid
- All placeholder values are replaced
- The layers array contains valid layer objects
- IDs are consistent throughout the structure

## Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| Invalid JSON after combination | Check comma placement between layers |
| Missing placeholders | Ensure all `{{}}` placeholders are replaced |
| ID conflicts | Use incremental IDs starting from base values |
| Layer index gaps | Ensure layers use sequential index values (0,1,2...) | 